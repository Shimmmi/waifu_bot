# üêâ –î–∏–∑–∞–π–Ω-–¥–æ–∫—É–º–µ–Ω—Ç: –ö–ª–∞–Ω–æ–≤—ã–µ —Ä–µ–π–¥—ã –Ω–∞ –±–æ—Å—Å–æ–≤

## üìã –û–±–∑–æ—Ä

–°–∏—Å—Ç–µ–º–∞ –∫–ª–∞–Ω–æ–≤—ã—Ö —Ä–µ–π–¥–æ–≤ –Ω–∞ –±–æ—Å—Å–æ–≤, –≥–¥–µ –∑–¥–æ—Ä–æ–≤—å–µ –±–æ—Å—Å–∞ —É–º–µ–Ω—å—à–∞–µ—Ç—Å—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∏–≥—Ä–æ–∫–æ–≤ –≤ –≥—Ä—É–ø–ø–æ–≤—ã—Ö —á–∞—Ç–∞—Ö Telegram. –ö–∞–∂–¥–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ –∏–≥—Ä–æ–∫–∞ (—Å–æ–æ–±—â–µ–Ω–∏–µ, —Å—Ç–∏–∫–µ—Ä, –≤–∏–¥–µ–æ –∏ —Ç.–¥.) –Ω–∞–Ω–æ—Å–∏—Ç —É—Ä–æ–Ω –±–æ—Å—Å—É, –∞ –Ω–∞–≥—Ä–∞–¥—ã —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –≤–∫–ª–∞–¥—É –∫–∞–∂–¥–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞.

---

## üéØ –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã

### 1. **–ó–¥–æ—Ä–æ–≤—å–µ –±–æ—Å—Å–∞ = –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∫–ª–∞–Ω–∞**
- –ë–æ—Å—Å –∏–º–µ–µ—Ç –±–æ–ª—å—à–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ HP (–Ω–∞–ø—Ä–∏–º–µ—Ä, 100,000 - 1,000,000+)
- –ö–∞–∂–¥–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ –∏–≥—Ä–æ–∫–∞ –≤ –≥—Ä—É–ø–ø–æ–≤—ã—Ö —á–∞—Ç–∞—Ö —É–º–µ–Ω—å—à–∞–µ—Ç HP –±–æ—Å—Å–∞
- –†–µ–π–¥ –¥–ª–∏—Ç—Å—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, 24-72 —á–∞—Å–∞) –∏–ª–∏ –¥–æ –ø–æ–±–µ–¥—ã

### 2. **–£—Ä–æ–Ω –æ—Ç –¥–µ–π—Å—Ç–≤–∏–π**
–†–∞–∑–Ω—ã–µ —Ç–∏–ø—ã –¥–µ–π—Å—Ç–≤–∏–π –Ω–∞–Ω–æ—Å—è—Ç —Ä–∞–∑–Ω—ã–π —É—Ä–æ–Ω:
- **–¢–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ** (‚â•5 —Å–∏–º–≤–æ–ª–æ–≤) = **-1 HP**
- **–°—Ç–∏–∫–µ—Ä/GIF** = **-2 HP**
- **–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ** = **-3 HP**
- **–í–∏–¥–µ–æ** = **-5 HP**
- **–ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ** = **-4 HP**
- **–°—Å—ã–ª–∫–∞ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏** = **-5 HP**
- **–î–æ–∫—É–º–µ–Ω—Ç** = **-2 HP**

### 3. **–ù–∞–≥—Ä–∞–¥—ã –ø–æ –≤–∫–ª–∞–¥—É**
- –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞–≥—Ä–∞–¥ –æ—Å–Ω–æ–≤–∞–Ω–æ –Ω–∞ –æ–±—â–µ–º —É—Ä–æ–Ω–µ, –Ω–∞–Ω–µ—Å–µ–Ω–Ω–æ–º –∫–∞–∂–¥—ã–º –∏–≥—Ä–æ–∫–æ–º
- –¢–æ–ø-–∏–≥—Ä–æ–∫–∏ –ø–æ–ª—É—á–∞—é—Ç –±–æ–Ω—É—Å–Ω—ã–µ –Ω–∞–≥—Ä–∞–¥—ã
- –í—Å–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏ –ø–æ–ª—É—á–∞—é—Ç –±–∞–∑–æ–≤—ã–µ –Ω–∞–≥—Ä–∞–¥—ã –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –≤–∫–ª–∞–¥—É

---

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã

### 1. **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö**

#### 1.1. –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã `clan_events`
–î–æ–±–∞–≤–∏—Ç—å –≤ `data` JSONB –ø–æ–ª–µ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –±–æ—Å—Å–µ:
```sql
-- data —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è raid:
{
  "boss_name": "–î—Ä–∞–∫–æ–Ω –ö–ª–∞–Ω–∞",
  "boss_max_hp": 500000,
  "boss_current_hp": 375000,
  "damage_dealt": 125000,
  "participant_count": 23,
  "activity_tracking": true  // –§–ª–∞–≥ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
}
```

#### 1.2. –ù–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞ `clan_raid_activity`
–î–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∫–∞–∂–¥–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞:
```sql
CREATE TABLE IF NOT EXISTS clan_raid_activity (
    id SERIAL PRIMARY KEY,
    event_id INTEGER NOT NULL REFERENCES clan_events(id) ON DELETE CASCADE,
    user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    chat_id BIGINT NOT NULL,  -- Telegram chat ID
    message_type VARCHAR(20) NOT NULL,  -- 'text', 'sticker', 'photo', 'video', 'voice', 'link'
    damage_dealt INTEGER NOT NULL DEFAULT 0,  -- –£—Ä–æ–Ω –æ—Ç —ç—Ç–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è
    message_id BIGINT,  -- Telegram message ID (–¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è)
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(event_id, user_id, message_id)  -- –û–¥–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ = –æ–¥–∏–Ω —É—Ä–æ–Ω
);

CREATE INDEX IF NOT EXISTS idx_raid_activity_event_id ON clan_raid_activity(event_id);
CREATE INDEX IF NOT EXISTS idx_raid_activity_user_id ON clan_raid_activity(user_id);
CREATE INDEX IF NOT EXISTS idx_raid_activity_chat_id ON clan_raid_activity(chat_id);
CREATE INDEX IF NOT EXISTS idx_raid_activity_created_at ON clan_raid_activity(created_at);
```

#### 1.3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ `clan_event_participations`
–î–æ–±–∞–≤–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è:
```sql
-- contribution —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è raid:
{
  "total_damage": 5000,  // –û–±—â–∏–π —É—Ä–æ–Ω
  "message_count": 2500,  // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π
  "damage_by_type": {
    "text": 1500,
    "sticker": 800,
    "photo": 600,
    "video": 200,
    "voice": 400
  },
  "participation_rate": 0.85  // –ü—Ä–æ—Ü–µ–Ω—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –æ—Ç –æ–±—â–µ–≥–æ —É—Ä–æ–Ω–∞ –∫–ª–∞–Ω–∞
}
```

---

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

### 2. **–û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –≥—Ä—É–ø–ø–æ–≤—ã—Ö —á–∞—Ç–∞—Ö**

#### 2.1. –ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è `message_handler.py`
–î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ä–µ–π–¥–æ–≤ –∏ –Ω–∞–Ω–µ—Å–µ–Ω–∏—è —É—Ä–æ–Ω–∞:

```python
# src/bot/handlers/message_handler.py

from bot.models import ClanMember, ClanEvent, ClanRaidActivity
from bot.services.clan_raid import ClanRaidService

@router.message()
async def handle_group_message(message: Message) -> None:
    """Handle messages in groups for global XP awarding and clan raid damage."""
    
    # ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è XP ...
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ —Ä–µ–π–¥—ã –∫–ª–∞–Ω–∞
    if user:
        raid_service = ClanRaidService()
        await raid_service.process_message_for_raid(
            session=session,
            user_id=user.id,
            chat_id=message.chat.id,
            message=message
        )
```

#### 2.2. –ù–æ–≤—ã–π —Å–µ—Ä–≤–∏—Å `ClanRaidService`
–°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª `src/bot/services/clan_raid.py`:

```python
"""
Clan Raid Service

–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∏–≥—Ä–æ–∫–æ–≤ –≤ –≥—Ä—É–ø–ø–æ–≤—ã—Ö —á–∞—Ç–∞—Ö –¥–ª—è –Ω–∞–Ω–µ—Å–µ–Ω–∏—è —É—Ä–æ–Ω–∞ –±–æ—Å—Å—É.
"""

class ClanRaidService:
    # –¢–∞–±–ª–∏—Ü–∞ —É—Ä–æ–Ω–∞ –ø–æ —Ç–∏–ø–∞–º —Å–æ–æ–±—â–µ–Ω–∏–π
    DAMAGE_BY_MESSAGE_TYPE = {
        "text": 1,
        "sticker": 2,
        "photo": 3,
        "video": 5,
        "voice": 4,
        "link": 5,
        "document": 2,
        "animation": 2,  # GIF
    }
    
    async def process_message_for_raid(
        self,
        session: Session,
        user_id: int,
        chat_id: int,
        message: Message
    ) -> Optional[Dict]:
        """
        –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ä–µ–π–¥–∞ –∫–ª–∞–Ω–∞.
        
        Returns:
            Dict —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ–± —É—Ä–æ–Ω–µ –∏–ª–∏ None, –µ—Å–ª–∏ —Ä–µ–π–¥–æ–≤ –Ω–µ—Ç
        """
        # 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ—Å—Ç–æ–∏—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –∫–ª–∞–Ω–µ
        member = session.query(ClanMember).filter(
            ClanMember.user_id == user_id
        ).first()
        
        if not member:
            return None
        
        # 2. –ò—â–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π —Ä–µ–π–¥ –¥–ª—è –∫–ª–∞–Ω–∞
        raid_event = session.query(ClanEvent).filter(
            and_(
                ClanEvent.clan_id == member.clan_id,
                ClanEvent.event_type == 'raid',
                ClanEvent.status == 'active'
            )
        ).first()
        
        if not raid_event:
            return None
        
        # 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ä–µ–π–¥ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
        event_data = raid_event.data or {}
        if not event_data.get('activity_tracking', False):
            return None
        
        # 4. –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è –∏ —É—Ä–æ–Ω
        message_type, damage = self._get_message_damage(message)
        
        if damage == 0:
            return None  # –ù–µ—Ç —É—Ä–æ–Ω–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ç–µ–∫—Å—Ç < 5 —Å–∏–º–≤–æ–ª–æ–≤)
        
        # 5. –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ –ª–∏ —É–∂–µ —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ
        existing_activity = session.query(ClanRaidActivity).filter(
            and_(
                ClanRaidActivity.event_id == raid_event.id,
                ClanRaidActivity.user_id == user_id,
                ClanRaidActivity.message_id == message.message_id
            )
        ).first()
        
        if existing_activity:
            return None  # –£–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ
        
        # 6. –°–æ—Ö—Ä–∞–Ω—è–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
        activity = ClanRaidActivity(
            event_id=raid_event.id,
            user_id=user_id,
            chat_id=chat_id,
            message_type=message_type,
            damage_dealt=damage,
            message_id=message.message_id
        )
        session.add(activity)
        
        # 7. –û–±–Ω–æ–≤–ª—è–µ–º HP –±–æ—Å—Å–∞
        current_hp = event_data.get('boss_current_hp', 0)
        new_hp = max(0, current_hp - damage)
        event_data['boss_current_hp'] = new_hp
        event_data['damage_dealt'] = event_data.get('damage_dealt', 0) + damage
        
        # 8. –û–±–Ω–æ–≤–ª—è–µ–º —É—á–∞—Å—Ç–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        participation = session.query(ClanEventParticipation).filter(
            and_(
                ClanEventParticipation.event_id == raid_event.id,
                ClanEventParticipation.user_id == user_id
            )
        ).first()
        
        if not participation:
            participation = ClanEventParticipation(
                event_id=raid_event.id,
                user_id=user_id,
                score=damage,
                contribution={
                    'total_damage': damage,
                    'message_count': 1,
                    'damage_by_type': {message_type: damage}
                }
            )
            session.add(participation)
        else:
            # –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ —É—á–∞—Å—Ç–∏–µ
            participation.score += damage
            contribution = participation.contribution or {}
            contribution['total_damage'] = contribution.get('total_damage', 0) + damage
            contribution['message_count'] = contribution.get('message_count', 0) + 1
            
            damage_by_type = contribution.get('damage_by_type', {})
            damage_by_type[message_type] = damage_by_type.get(message_type, 0) + damage
            contribution['damage_by_type'] = damage_by_type
            
            participation.contribution = contribution
            flag_modified(participation, 'contribution')
        
        # 9. –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø–æ–±–µ–∂–¥–µ–Ω –ª–∏ –±–æ—Å—Å
        if new_hp <= 0:
            await self._finalize_raid(session, raid_event)
        
        # 10. –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–±—ã—Ç–∏–µ
        raid_event.data = event_data
        flag_modified(raid_event, 'data')
        
        session.commit()
        
        return {
            'damage': damage,
            'boss_hp': new_hp,
            'boss_max_hp': event_data.get('boss_max_hp', 0),
            'boss_defeated': new_hp <= 0
        }
    
    def _get_message_damage(self, message: Message) -> Tuple[str, int]:
        """
        –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —É—Ä–æ–Ω.
        
        Returns:
            (message_type, damage)
        """
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
        if message.text:
            text_length = len(message.text.strip())
            if text_length >= 5:
                # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å—Å—ã–ª–∫–∏
                if message.entities:
                    for entity in message.entities:
                        if entity.type in ["url", "text_link"]:
                            return ("link", self.DAMAGE_BY_MESSAGE_TYPE["link"])
                return ("text", self.DAMAGE_BY_MESSAGE_TYPE["text"])
            return ("text", 0)  # –°–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—Ä—É–≥–∏—Ö —Ç–∏–ø–æ–≤
        if message.sticker:
            return ("sticker", self.DAMAGE_BY_MESSAGE_TYPE["sticker"])
        if message.photo:
            return ("photo", self.DAMAGE_BY_MESSAGE_TYPE["photo"])
        if message.video or message.video_note:
            return ("video", self.DAMAGE_BY_MESSAGE_TYPE["video"])
        if message.voice:
            return ("voice", self.DAMAGE_BY_MESSAGE_TYPE["voice"])
        if message.document:
            return ("document", self.DAMAGE_BY_MESSAGE_TYPE["document"])
        if message.animation:
            return ("animation", self.DAMAGE_BY_MESSAGE_TYPE["animation"])
        
        return ("unknown", 0)
    
    async def _finalize_raid(
        self,
        session: Session,
        raid_event: ClanEvent
    ) -> None:
        """
        –ó–∞–≤–µ—Ä—à–∞–µ—Ç —Ä–µ–π–¥, —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç –Ω–∞–≥—Ä–∞–¥—ã –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è.
        """
        # 1. –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —Ä–µ–π–¥–∞
        raid_event.status = 'completed'
        raid_event.ends_at = datetime.utcnow()
        
        # 2. –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —Å –∏—Ö —É—Ä–æ–Ω–æ–º
        participations = session.query(ClanEventParticipation).filter(
            ClanEventParticipation.event_id == raid_event.id
        ).order_by(ClanEventParticipation.score.desc()).all()
        
        if not participations:
            session.commit()
            return
        
        # 3. –í—ã—á–∏—Å–ª—è–µ–º –æ–±—â–∏–π —É—Ä–æ–Ω –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤
        total_damage = sum(p.score for p in participations)
        
        # 4. –†–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞–≥—Ä–∞–¥—ã
        base_rewards = {
            'gold': 5000,  # –ë–∞–∑–æ–≤–æ–µ –∑–æ–ª–æ—Ç–æ –∑–∞ –ø–æ–±–µ–¥—É
            'gems': 100,   # –ë–∞–∑–æ–≤—ã–µ –≥–µ–º—ã
            'skill_points': 50  # –ë–∞–∑–æ–≤—ã–µ –æ—á–∫–∏ –Ω–∞–≤—ã–∫–æ–≤
        }
        
        # 5. –ù–∞–≥—Ä–∞–∂–¥–∞–µ–º –∫–∞–∂–¥–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞
        for idx, participation in enumerate(participations):
            user = session.query(User).filter(User.id == participation.user_id).first()
            if not user:
                continue
            
            # –ë–∞–∑–æ–≤—ã–µ –Ω–∞–≥—Ä–∞–¥—ã –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –≤–∫–ª–∞–¥—É
            contribution_rate = participation.score / total_damage if total_damage > 0 else 0
            
            gold_reward = int(base_rewards['gold'] * contribution_rate)
            gems_reward = int(base_rewards['gems'] * contribution_rate)
            skill_points_reward = int(base_rewards['skill_points'] * contribution_rate)
            
            # –ë–æ–Ω—É—Å—ã –∑–∞ –º–µ—Å—Ç–æ –≤ —Ç–æ–ø–µ
            if idx == 0:  # 1 –º–µ—Å—Ç–æ
                gold_reward += 5000
                gems_reward += 200
                skill_points_reward += 100
            elif idx == 1:  # 2 –º–µ—Å—Ç–æ
                gold_reward += 3000
                gems_reward += 150
                skill_points_reward += 75
            elif idx == 2:  # 3 –º–µ—Å—Ç–æ
                gold_reward += 2000
                gems_reward += 100
                skill_points_reward += 50
            elif idx < 10:  # –¢–æ–ø-10
                gold_reward += 1000
                gems_reward += 50
                skill_points_reward += 25
            
            # –í—ã–¥–∞–µ–º –Ω–∞–≥—Ä–∞–¥—ã
            user.coins += gold_reward
            user.gems += gems_reward
            
            # –û–±–Ω–æ–≤–ª—è–µ–º –æ—á–∫–∏ –Ω–∞–≤—ã–∫–æ–≤
            try:
                from bot.models import UserSkills
                user_skills = session.query(UserSkills).filter(
                    UserSkills.user_id == user.id
                ).first()
                if user_skills:
                    user_skills.skill_points += skill_points_reward
            except:
                pass
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞–≥—Ä–∞–¥—ã –≤ participation
            participation.contribution['rewards'] = {
                'gold': gold_reward,
                'gems': gems_reward,
                'skill_points': skill_points_reward
            }
            flag_modified(participation, 'contribution')
        
        # 6. –û–±–Ω–æ–≤–ª—è–µ–º –æ–ø—ã—Ç –∫–ª–∞–Ω–∞
        clan = session.query(Clan).filter(Clan.id == raid_event.clan_id).first()
        if clan:
            clan.experience += 500  # –ë–æ–Ω—É—Å –æ–ø—ã—Ç–∞ –∑–∞ –ø–æ–±–µ–¥—É –≤ —Ä–µ–π–¥–µ
        
        # 7. –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞–≥—Ä–∞–¥—ã –≤ —Å–æ–±—ã—Ç–∏–∏
        raid_event.rewards = {
            'distributed': True,
            'total_participants': len(participations),
            'total_damage': total_damage
        }
        
        session.commit()
        
        # 8. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ)
        # TODO: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤ –∫–ª–∞–Ω–æ–≤—ã–π —á–∞—Ç
        
        logger.info(f"‚úÖ Raid {raid_event.id} completed! Total damage: {total_damage}")
```

---

### 3. **API Endpoints**

#### 3.1. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö endpoints

**`POST /api/clans/raid/start`**
- –î–æ–±–∞–≤–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä `activity_tracking: bool = True`
- –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å `activity_tracking` –≤ `data` —Ä–µ–π–¥–∞

**`GET /api/clans/raid/status`** (–Ω–æ–≤—ã–π)
```python
@router.get("/api/clans/raid/status")
async def get_raid_status(request, db: Session = Depends(get_db)) -> Dict[str, Any]:
    """–ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ä–µ–π–¥–∞"""
    user = get_user_from_request(request, db)
    member = db.query(ClanMember).filter(ClanMember.user_id == user.id).first()
    
    if not member:
        raise HTTPException(status_code=403, detail="–í—ã –Ω–µ —Å–æ—Å—Ç–æ–∏—Ç–µ –≤ –∫–ª–∞–Ω–µ")
    
    raid_event = db.query(ClanEvent).filter(
        and_(
            ClanEvent.clan_id == member.clan_id,
            ClanEvent.event_type == 'raid',
            ClanEvent.status == 'active'
        )
    ).first()
    
    if not raid_event:
        return {"active": False}
    
    event_data = raid_event.data or {}
    
    # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
    participations = db.query(ClanEventParticipation).filter(
        ClanEventParticipation.event_id == raid_event.id
    ).order_by(ClanEventParticipation.score.desc()).limit(10).all()
    
    leaderboard = []
    for p in participations:
        participant_user = db.query(User).filter(User.id == p.user_id).first()
        if participant_user:
            leaderboard.append({
                'username': participant_user.display_name or participant_user.username,
                'damage': p.score,
                'contribution': p.contribution
            })
    
    return {
        "active": True,
        "boss_name": event_data.get('boss_name', '–î—Ä–∞–∫–æ–Ω –ö–ª–∞–Ω–∞'),
        "boss_max_hp": event_data.get('boss_max_hp', 0),
        "boss_current_hp": event_data.get('boss_current_hp', 0),
        "damage_dealt": event_data.get('damage_dealt', 0),
        "hp_percentage": (event_data.get('boss_current_hp', 0) / event_data.get('boss_max_hp', 1)) * 100,
        "leaderboard": leaderboard,
        "ends_at": raid_event.ends_at.isoformat() if raid_event.ends_at else None
    }
```

**`GET /api/clans/raid/my-contribution`** (–Ω–æ–≤—ã–π)
```python
@router.get("/api/clans/raid/my-contribution")
async def get_my_contribution(request, db: Session = Depends(get_db)) -> Dict[str, Any]:
    """–ü–æ–ª—É—á–∏—Ç—å —Å–≤–æ–π –≤–∫–ª–∞–¥ –≤ –∞–∫—Ç–∏–≤–Ω—ã–π —Ä–µ–π–¥"""
    user = get_user_from_request(request, db)
    member = db.query(ClanMember).filter(ClanMember.user_id == user.id).first()
    
    if not member:
        raise HTTPException(status_code=403, detail="–í—ã –Ω–µ —Å–æ—Å—Ç–æ–∏—Ç–µ –≤ –∫–ª–∞–Ω–µ")
    
    raid_event = db.query(ClanEvent).filter(
        and_(
            ClanEvent.clan_id == member.clan_id,
            ClanEvent.event_type == 'raid',
            ClanEvent.status == 'active'
        )
    ).first()
    
    if not raid_event:
        return {"participating": False}
    
    participation = db.query(ClanEventParticipation).filter(
        and_(
            ClanEventParticipation.event_id == raid_event.id,
            ClanEventParticipation.user_id == user.id
        )
    ).first()
    
    if not participation:
        return {"participating": False, "damage": 0}
    
    # –ü–æ–ª—É—á–∞–µ–º –æ–±—â–∏–π —É—Ä–æ–Ω –∫–ª–∞–Ω–∞
    total_damage = db.query(
        func.sum(ClanEventParticipation.score)
    ).filter(
        ClanEventParticipation.event_id == raid_event.id
    ).scalar() or 0
    
    contribution_rate = (participation.score / total_damage * 100) if total_damage > 0 else 0
    
    return {
        "participating": True,
        "damage": participation.score,
        "contribution_percentage": round(contribution_rate, 2),
        "message_count": participation.contribution.get('message_count', 0),
        "damage_by_type": participation.contribution.get('damage_by_type', {})
    }
```

---

### 4. **–†–∞—Å—á–µ—Ç HP –±–æ—Å—Å–∞**

#### 4.1. –§–æ—Ä–º—É–ª–∞ —Ä–∞—Å—á–µ—Ç–∞
```python
def calculate_boss_hp(clan: Clan, session: Session) -> int:
    """
    –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ HP –±–æ—Å—Å–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–∏–ª—ã –∫–ª–∞–Ω–∞.
    
    –§–æ—Ä–º—É–ª–∞:
    - –ë–∞–∑–æ–≤–∞—è —Å–∏–ª–∞ –∫–ª–∞–Ω–∞ = sum(–º–æ—â—å –∞–∫—Ç–∏–≤–Ω—ã—Ö –≤–∞–π—Ñ—É –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤)
    - HP –±–æ—Å—Å–∞ = –ë–∞–∑–æ–≤–∞—è —Å–∏–ª–∞ √ó –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ √ó –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —É—Ä–æ–≤–Ω—è –∫–ª–∞–Ω–∞
    
    –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã:
    - –ë–∞–∑–æ–≤–∞—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å: 100 (–±–æ—Å—Å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å–∏–ª—å–Ω—ã–º)
    - –ú–Ω–æ–∂–∏—Ç–µ–ª—å —É—Ä–æ–≤–Ω—è –∫–ª–∞–Ω–∞: 1 + (—É—Ä–æ–≤–µ–Ω—å_–∫–ª–∞–Ω–∞ * 0.1)
    
    –ü—Ä–∏–º–µ—Ä:
    - –ö–ª–∞–Ω —Å —Å–∏–ª–æ–π 50,000, —É—Ä–æ–≤–µ–Ω—å 10
    - HP = 50,000 √ó 100 √ó (1 + 10 √ó 0.1) = 50,000 √ó 100 √ó 2 = 10,000,000 HP
    """
    # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
    members = session.query(ClanMember).filter(
        ClanMember.clan_id == clan.id
    ).all()
    
    total_power = 0
    for member in members:
        waifu = session.query(Waifu).filter(
            and_(
                Waifu.owner_id == member.user_id,
                Waifu.is_active == True
            )
        ).first()
        
        if waifu:
            from bot.services.waifu_generator import calculate_waifu_power
            from bot.services.skill_effects import get_user_skill_effects
            
            skill_effects = get_user_skill_effects(session, member.user_id)
            power = calculate_waifu_power({
                'stats': waifu.stats or {},
                'dynamic': waifu.dynamic or {},
                'level': waifu.level,
                'rarity': waifu.rarity
            }, skill_effects)
            
            total_power += power
    
    # –ë–∞–∑–æ–≤–∞—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å
    BASE_DIFFICULTY = 100
    
    # –ú–Ω–æ–∂–∏—Ç–µ–ª—å —É—Ä–æ–≤–Ω—è –∫–ª–∞–Ω–∞
    level_multiplier = 1 + (clan.level * 0.1)
    
    # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º HP
    boss_hp = int(total_power * BASE_DIFFICULTY * level_multiplier)
    
    # –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ HP (–¥–ª—è –º–∞–ª–µ–Ω—å–∫–∏—Ö –∫–ª–∞–Ω–æ–≤)
    min_hp = 100000
    boss_hp = max(boss_hp, min_hp)
    
    return boss_hp
```

---

## üéÆ UI/UX –∏–∑–º–µ–Ω–µ–Ω–∏—è

### 5. **–í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å**

#### 5.1. –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Ä–µ–π–¥–∞ –≤ WebApp
–û–±–Ω–æ–≤–∏—Ç—å `webapp/app.js` –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ä–µ–π–¥–∞:

```javascript
// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ —Ä–µ–π–¥–∞
async function loadRaidStatus() {
    const initData = window.Telegram?.WebApp?.initData || '';
    const response = await fetch(`/api/clans/raid/status?${new URLSearchParams({ initData })}`);
    
    if (!response.ok) {
        return null;
    }
    
    const data = await response.json();
    return data;
}

// –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–π–¥–∞ –≤ UI –∫–ª–∞–Ω–∞
async function renderRaidSection(container) {
    const raidStatus = await loadRaidStatus();
    
    if (!raidStatus || !raidStatus.active) {
        // –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ä–µ–π–¥–∞
        container.innerHTML = `
            <div style="padding: 16px; text-align: center; background: #f5f5f5; border-radius: 8px;">
                <h3 style="margin: 0 0 8px 0;">üêâ –ö–ª–∞–Ω–æ–≤—ã–π —Ä–µ–π–¥</h3>
                <p style="margin: 0 0 16px 0; color: #666;">–ê–∫—Ç–∏–≤–Ω—ã—Ö —Ä–µ–π–¥–æ–≤ –Ω–µ—Ç</p>
                <button onclick="startRaid()" style="padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    –ù–∞—á–∞—Ç—å —Ä–µ–π–¥
                </button>
            </div>
        `;
        return;
    }
    
    const hpPercent = raidStatus.hp_percentage.toFixed(1);
    const hpBarColor = hpPercent > 50 ? '#4ade80' : hpPercent > 25 ? '#fbbf24' : '#ef4444';
    
    container.innerHTML = `
        <div style="padding: 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; color: white;">
            <h3 style="margin: 0 0 12px 0; font-size: 20px;">üêâ ${raidStatus.boss_name}</h3>
            
            <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å HP -->
            <div style="margin-bottom: 12px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 12px;">
                    <span>HP: ${raidStatus.boss_current_hp.toLocaleString()} / ${raidStatus.boss_max_hp.toLocaleString()}</span>
                    <span>${hpPercent}%</span>
                </div>
                <div style="background: rgba(255,255,255,0.2); border-radius: 4px; height: 20px; overflow: hidden;">
                    <div style="background: ${hpBarColor}; height: 100%; width: ${hpPercent}%; transition: width 0.3s;"></div>
                </div>
            </div>
            
            <!-- –£—Ä–æ–Ω -->
            <div style="margin-bottom: 12px; font-size: 14px;">
                üí• –ù–∞–Ω–µ—Å–µ–Ω–æ —É—Ä–æ–Ω–∞: <strong>${raidStatus.damage_dealt.toLocaleString()}</strong>
            </div>
            
            <!-- –ú–æ–π –≤–∫–ª–∞–¥ -->
            <div id="my-raid-contribution" style="margin-bottom: 16px; padding: 12px; background: rgba(255,255,255,0.1); border-radius: 4px; font-size: 14px;">
                –ó–∞–≥—Ä—É–∑–∫–∞...
            </div>
            
            <!-- –õ–∏–¥–µ—Ä–±–æ—Ä–¥ -->
            <div>
                <h4 style="margin: 0 0 8px 0; font-size: 16px;">üèÜ –¢–æ–ø —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤:</h4>
                <div style="max-height: 200px; overflow-y: auto;">
                    ${raidStatus.leaderboard.map((entry, idx) => `
                        <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 13px;">
                            <span>${idx + 1}. ${entry.username}</span>
                            <span>üí• ${entry.damage.toLocaleString()}</span>
                        </div>
                    `).join('')}
                </div>
            </div>
        </div>
    `;
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –º–æ–π –≤–∫–ª–∞–¥
    loadMyContribution();
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–µ–≥–æ –≤–∫–ª–∞–¥–∞
async function loadMyContribution() {
    const initData = window.Telegram?.WebApp?.initData || '';
    const response = await fetch(`/api/clans/raid/my-contribution?${new URLSearchParams({ initData })}`);
    
    if (!response.ok) {
        return;
    }
    
    const data = await response.json();
    const container = document.getElementById('my-raid-contribution');
    
    if (!container) return;
    
    if (!data.participating) {
        container.innerHTML = `
            <div style="text-align: center; color: rgba(255,255,255,0.8);">
                üìù –ù–∞–ø–∏—à–∏—Ç–µ —á—Ç–æ-–Ω–∏–±—É–¥—å –≤ –≥—Ä—É–ø–ø–æ–≤–æ–º —á–∞—Ç–µ, —á—Ç–æ–±—ã –Ω–∞–Ω–µ—Å—Ç–∏ —É—Ä–æ–Ω –±–æ—Å—Å—É!
            </div>
        `;
        return;
    }
    
    container.innerHTML = `
        <div>
            <div style="font-weight: bold; margin-bottom: 6px;">–í–∞—à –≤–∫–ª–∞–¥:</div>
            <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                <span>üí• –£—Ä–æ–Ω:</span>
                <span><strong>${data.damage.toLocaleString()}</strong></span>
            </div>
            <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                <span>üìù –°–æ–æ–±—â–µ–Ω–∏–π:</span>
                <span><strong>${data.message_count}</strong></span>
            </div>
            <div style="display: flex; justify-content: space-between;">
                <span>üìä –í–∫–ª–∞–¥:</span>
                <span><strong>${data.contribution_percentage}%</strong></span>
            </div>
        </div>
    `;
}

// –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —Ä–µ–π–¥–∞ (–∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥)
let raidStatusInterval = null;

function startRaidStatusAutoRefresh() {
    if (raidStatusInterval) {
        clearInterval(raidStatusInterval);
    }
    
    raidStatusInterval = setInterval(async () => {
        const clanContainer = document.getElementById('clan-section');
        if (clanContainer && currentView === 'clan') {
            await renderRaidSection(clanContainer.querySelector('#raid-section'));
        }
    }, 5000);
}

function stopRaidStatusAutoRefresh() {
    if (raidStatusInterval) {
        clearInterval(raidStatusInterval);
        raidStatusInterval = null;
    }
}
```

---

## üìä –ü—Ä–∏–º–µ—Ä—ã —Ä–∞—Å—á–µ—Ç–æ–≤

### 6. **–ü—Ä–∏–º–µ—Ä—ã**

#### –ü—Ä–∏–º–µ—Ä 1: –ú–∞–ª–µ–Ω—å–∫–∏–π –∫–ª–∞–Ω (10 —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤)
- –°—Ä–µ–¥–Ω—è—è –º–æ—â–Ω–æ—Å—Ç—å –≤–∞–π—Ñ—É: 5,000
- –û–±—â–∞—è —Å–∏–ª–∞ –∫–ª–∞–Ω–∞: 50,000
- –£—Ä–æ–≤–µ–Ω—å –∫–ª–∞–Ω–∞: 5
- **HP –±–æ—Å—Å–∞**: 50,000 √ó 100 √ó 1.5 = **7,500,000 HP**

#### –ü—Ä–∏–º–µ—Ä 2: –°—Ä–µ–¥–Ω–∏–π –∫–ª–∞–Ω (25 —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤)
- –°—Ä–µ–¥–Ω—è—è –º–æ—â–Ω–æ—Å—Ç—å –≤–∞–π—Ñ—É: 10,000
- –û–±—â–∞—è —Å–∏–ª–∞ –∫–ª–∞–Ω–∞: 250,000
- –£—Ä–æ–≤–µ–Ω—å –∫–ª–∞–Ω–∞: 15
- **HP –±–æ—Å—Å–∞**: 250,000 √ó 100 √ó 2.5 = **62,500,000 HP**

#### –ü—Ä–∏–º–µ—Ä 3: –ë–æ–ª—å—à–æ–π –∫–ª–∞–Ω (50 —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤)
- –°—Ä–µ–¥–Ω—è—è –º–æ—â–Ω–æ—Å—Ç—å –≤–∞–π—Ñ—É: 15,000
- –û–±—â–∞—è —Å–∏–ª–∞ –∫–ª–∞–Ω–∞: 750,000
- –£—Ä–æ–≤–µ–Ω—å –∫–ª–∞–Ω–∞: 25
- **HP –±–æ—Å—Å–∞**: 750,000 √ó 100 √ó 3.5 = **262,500,000 HP**

---

## üéØ –ù–∞–≥—Ä–∞–¥—ã

### 7. **–°–∏—Å—Ç–µ–º–∞ –Ω–∞–≥—Ä–∞–¥**

#### –ë–∞–∑–æ–≤—ã–µ –Ω–∞–≥—Ä–∞–¥—ã (–ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –≤–∫–ª–∞–¥—É):
- **–ó–æ–ª–æ—Ç–æ**: 5,000 √ó (–≤–∞—à_—É—Ä–æ–Ω / –æ–±—â–∏–π_—É—Ä–æ–Ω)
- **–ì–µ–º—ã**: 100 √ó (–≤–∞—à_—É—Ä–æ–Ω / –æ–±—â–∏–π_—É—Ä–æ–Ω)
- **–û—á–∫–∏ –Ω–∞–≤—ã–∫–æ–≤**: 50 √ó (–≤–∞—à_—É—Ä–æ–Ω / –æ–±—â–∏–π_—É—Ä–æ–Ω)

#### –ë–æ–Ω—É—Å—ã –∑–∞ –º–µ—Å—Ç–æ:
- **1 –º–µ—Å—Ç–æ**: +5,000 –∑–æ–ª–æ—Ç–∞, +200 –≥–µ–º–æ–≤, +100 –æ—á–∫–æ–≤ –Ω–∞–≤—ã–∫–æ–≤
- **2 –º–µ—Å—Ç–æ**: +3,000 –∑–æ–ª–æ—Ç–∞, +150 –≥–µ–º–æ–≤, +75 –æ—á–∫–æ–≤ –Ω–∞–≤—ã–∫–æ–≤
- **3 –º–µ—Å—Ç–æ**: +2,000 –∑–æ–ª–æ—Ç–∞, +100 –≥–µ–º–æ–≤, +50 –æ—á–∫–æ–≤ –Ω–∞–≤—ã–∫–æ–≤
- **–¢–æ–ø-10**: +1,000 –∑–æ–ª–æ—Ç–∞, +50 –≥–µ–º–æ–≤, +25 –æ—á–∫–æ–≤ –Ω–∞–≤—ã–∫–æ–≤

#### –ö–ª–∞–Ω–æ–≤—ã–µ –Ω–∞–≥—Ä–∞–¥—ã:
- **–û–ø—ã—Ç –∫–ª–∞–Ω–∞**: +500 –æ–ø—ã—Ç–∞ –∑–∞ –ø–æ–±–µ–¥—É
- **–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è**: –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π –∫–ª–∞–Ω–∞

---

## üîÑ –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª —Ä–µ–π–¥–∞

### 8. **–≠—Ç–∞–ø—ã —Ä–µ–π–¥–∞**

1. **–ó–∞–ø—É—Å–∫ —Ä–µ–π–¥–∞** (–ª–∏–¥–µ—Ä/–æ—Ñ–∏—Ü–µ—Ä):
   - –í—ã–±–∏—Ä–∞–µ—Ç—Å—è –±–æ—Å—Å
   - –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è HP –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–∏–ª—ã –∫–ª–∞–Ω–∞
   - –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –≤—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è (24-72 —á–∞—Å–∞)
   - –í–∫–ª—é—á–∞–µ—Ç—Å—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏

2. **–ê–∫—Ç–∏–≤–Ω–∞—è —Ñ–∞–∑–∞**:
   - –ò–≥—Ä–æ–∫–∏ –ø–∏—à—É—Ç –≤ –≥—Ä—É–ø–ø–æ–≤—ã–µ —á–∞—Ç—ã
   - –ö–∞–∂–¥–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —É–º–µ–Ω—å—à–∞–µ—Ç HP –±–æ—Å—Å–∞
   - –†–µ–∞–ª—å–Ω—ã–π —Ç–∞–π–º–ª–∞–π–Ω –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥ –≤ WebApp
   - –õ–∏–¥–µ—Ä–±–æ—Ä–¥ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏

3. **–ü–æ–±–µ–¥–∞**:
   - –ö–æ–≥–¥–∞ HP –±–æ—Å—Å–∞ –¥–æ—Å—Ç–∏–≥–∞–µ—Ç 0
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è –Ω–∞–≥—Ä–∞–¥—ã
   - –û—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤—Å–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–∞–º
   - –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –æ–ø—ã—Ç –∫–ª–∞–Ω–∞

4. **–¢–∞–π–º–∞—É—Ç** (–µ—Å–ª–∏ –Ω–µ –ø–æ–±–µ–¥–∏–ª–∏):
   - –†–µ–π–¥ –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è –ø–æ –≤—Ä–µ–º–µ–Ω–∏
   - –ß–∞—Å—Ç–∏—á–Ω—ã–µ –Ω–∞–≥—Ä–∞–¥—ã –∑–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å
   - –ë–æ—Å—Å –æ—Å—Ç–∞–µ—Ç—Å—è –Ω–µ–ø–æ–±–µ–∂–¥–µ–Ω–Ω—ã–º

---

## ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞

### 9. **–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏**

```python
# –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –¥–ª—è –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏
RAID_CONFIG = {
    'min_duration_hours': 24,      # –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
    'max_duration_hours': 72,       # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
    'base_difficulty': 100,         # –ë–∞–∑–æ–≤–∞—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å (–º–Ω–æ–∂–∏—Ç–µ–ª—å HP)
    'level_multiplier': 0.1,        # –ú–Ω–æ–∂–∏—Ç–µ–ª—å —É—Ä–æ–≤–Ω—è –∫–ª–∞–Ω–∞
    'min_boss_hp': 100000,          # –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ HP –±–æ—Å—Å–∞
    'damage_text': 1,               # –£—Ä–æ–Ω –æ—Ç —Ç–µ–∫—Å—Ç–∞
    'damage_sticker': 2,            # –£—Ä–æ–Ω –æ—Ç —Å—Ç–∏–∫–µ—Ä–∞
    'damage_photo': 3,              # –£—Ä–æ–Ω –æ—Ç —Ñ–æ—Ç–æ
    'damage_video': 5,              # –£—Ä–æ–Ω –æ—Ç –≤–∏–¥–µ–æ
    'damage_voice': 4,              # –£—Ä–æ–Ω –æ—Ç –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ
    'damage_link': 5,               # –£—Ä–æ–Ω –æ—Ç —Å—Å—ã–ª–∫–∏
    'base_reward_gold': 5000,       # –ë–∞–∑–æ–≤–æ–µ –∑–æ–ª–æ—Ç–æ
    'base_reward_gems': 100,        # –ë–∞–∑–æ–≤—ã–µ –≥–µ–º—ã
    'base_reward_skill_points': 50, # –ë–∞–∑–æ–≤—ã–µ –æ—á–∫–∏ –Ω–∞–≤—ã–∫–æ–≤
    'clan_exp_reward': 500,         # –û–ø—ã—Ç –∫–ª–∞–Ω–∞ –∑–∞ –ø–æ–±–µ–¥—É
}
```

---

## üìù –ß–µ–∫–ª–∏—Å—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### 10. **–≠—Ç–∞–ø—ã —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏**

#### –§–∞–∑–∞ 1: –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏ –º–æ–¥–µ–ª–∏
- [ ] –°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É `clan_raid_activity`
- [ ] –°–æ–∑–¥–∞—Ç—å –º–æ–¥–µ–ª—å `ClanRaidActivity`
- [ ] –û–±–Ω–æ–≤–∏—Ç—å –º–æ–¥–µ–ª—å `ClanEvent` –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ `activity_tracking`
- [ ] SQL –º–∏–≥—Ä–∞—Ü–∏—è –¥–ª—è –Ω–æ–≤—ã—Ö —Ç–∞–±–ª–∏—Ü

#### –§–∞–∑–∞ 2: –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
- [ ] –°–æ–∑–¥–∞—Ç—å —Å–µ—Ä–≤–∏—Å `ClanRaidService`
- [ ] –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É —Ä–µ–π–¥–æ–≤ –≤ `message_handler.py`
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ —É—Ä–æ–Ω–∞
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏

#### –§–∞–∑–∞ 3: API Endpoints
- [ ] –û–±–Ω–æ–≤–∏—Ç—å `POST /api/clans/raid/start` –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è `activity_tracking`
- [ ] –°–æ–∑–¥–∞—Ç—å `GET /api/clans/raid/status`
- [ ] –°–æ–∑–¥–∞—Ç—å `GET /api/clans/raid/my-contribution`
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–µ–π–¥–∞ –ø—Ä–∏ HP = 0

#### –§–∞–∑–∞ 4: –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞–≥—Ä–∞–¥
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é `_finalize_raid`
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ä–∞—Å—á–µ—Ç –Ω–∞–≥—Ä–∞–¥ –ø–æ –≤–∫–ª–∞–¥—É
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –±–æ–Ω—É—Å—ã –∑–∞ –º–µ—Å—Ç–æ –≤ —Ç–æ–ø–µ
- [ ] –î–æ–±–∞–≤–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–ø—ã—Ç–∞ –∫–ª–∞–Ω–∞

#### –§–∞–∑–∞ 5: UI/UX
- [ ] –û–±–Ω–æ–≤–∏—Ç—å WebApp –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ä–µ–π–¥–∞
- [ ] –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä HP –±–æ—Å—Å–∞
- [ ] –î–æ–±–∞–≤–∏—Ç—å –ª–∏–¥–µ—Ä–±–æ—Ä–¥ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
- [ ] –î–æ–±–∞–≤–∏—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ª–∏—á–Ω–æ–≥–æ –≤–∫–ª–∞–¥–∞
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —Ä–µ–π–¥–∞

#### –§–∞–∑–∞ 6: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –º–∞–ª–µ–Ω—å–∫–∏–º –∫–ª–∞–Ω–æ–º
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ —Å—Ä–µ–¥–Ω–∏–º –∫–ª–∞–Ω–æ–º
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –±–æ–ª—å—à–∏–º –∫–ª–∞–Ω–æ–º
- [ ] –ë–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞ HP –±–æ—Å—Å–∞ –∏ –Ω–∞–≥—Ä–∞–¥
- [ ] –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

---

## üö® –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

### 11. **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏**

1. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**:
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ä–µ–π–¥–æ–≤
   - –ö—ç—à–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–∞—Ç—É—Å —Ä–µ–π–¥–∞ –≤ Redis –¥–ª—è —É–º–µ–Ω—å—à–µ–Ω–∏—è –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ –ë–î
   - –ë–∞—Ç—á-–æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π HP –±–æ—Å—Å–∞ (–Ω–µ –Ω–∞ –∫–∞–∂–¥–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ)

2. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**:
   - –ü—Ä–æ–≤–µ—Ä—è—Ç—å, —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –¥–≤–∞–∂–¥—ã
   - –í–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–Ω–æ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫ –∫–ª–∞–Ω—É
   - –û–≥—Ä–∞–Ω–∏—á–∏—Ç—å —á–∞—Å—Ç–æ—Ç—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π API

3. **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å**:
   - –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –æ—á–µ—Ä–µ–¥–∏ —Å–æ–æ–±—â–µ–Ω–∏–π (Redis/RabbitMQ)
   - –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–µ–π–¥–æ–≤
   - –ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã `clan_raid_activity` –ø–æ –¥–∞—Ç–∞–º

4. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**:
   - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –¥–µ–π—Å—Ç–≤–∏–π –≤ —Ä–µ–π–¥–µ
   - –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
   - –ê–ª–µ—Ä—Ç—ã –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

---

## üìö –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

- `src/bot/handlers/message_handler.py` - –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
- `src/bot/services/clan_raid.py` - –°–µ—Ä–≤–∏—Å —Ä–µ–π–¥–æ–≤ (–Ω–æ–≤—ã–π)
- `src/bot/api_clans_events.py` - API endpoints –¥–ª—è —Ä–µ–π–¥–æ–≤
- `src/bot/models.py` - –ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö
- `webapp/app.js` - UI —Ä–µ–π–¥–æ–≤
- `sql/013_add_clan_raid_activity.sql` - SQL –º–∏–≥—Ä–∞—Ü–∏—è (–Ω–æ–≤—ã–π)

---

## üéâ –ò—Ç–æ–≥

–î–∞–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –ø–æ–∑–≤–æ–ª—è–µ—Ç —Å–æ–∑–¥–∞—Ç—å –¥–∏–Ω–∞–º–∏—á–Ω—ã–π –∏ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –≥–µ–π–º–ø–ª–µ–π, –≥–¥–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∏–≥—Ä–æ–∫–æ–≤ –≤ –≥—Ä—É–ø–ø–æ–≤—ã—Ö —á–∞—Ç–∞—Ö –Ω–∞–ø—Ä—è–º—É—é –≤–ª–∏—è–µ—Ç –Ω–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å –∫–ª–∞–Ω–æ–≤–æ–≥–æ —Ä–µ–π–¥–∞. –≠—Ç–æ –º–æ—Ç–∏–≤–∏—Ä—É–µ—Ç –∏–≥—Ä–æ–∫–æ–≤ –±—ã—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–º–∏ –≤ —á–∞—Ç–∞—Ö –∏ —Ä–∞–±–æ—Ç–∞—Ç—å –≤–º–µ—Å—Ç–µ –¥–ª—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –æ–±—â–µ–π —Ü–µ–ª–∏.
